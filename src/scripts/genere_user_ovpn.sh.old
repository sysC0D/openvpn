#!/bin/bash
#Auto-Genere user openvpn

echo "Welcome to Auto-Genere user-OpenVPN..."
echo ""

#Get public IP
publicIP=`dig +short myip.opendns.com @resolver1.opendns.com`
echo "Your public IP is : $publicIP"

echo ""
echo "1.1 -> Init conf var" 
cd /etc/openvpn/easy-rsa/easyrsa3
cp vars.example vars
echo "set_var EASYRSA_REQ_COUNTRY    \"US\"" >> vars
echo "set_var EASYRSA_REQ_PROVINCE   \"California\"" >> vars
echo "set_var EASYRSA_REQ_CITY       \"San Francisco\"" >> vars
echo "set_var EASYRSA_REQ_ORG        \"6c0d\"" >> vars
echo "set_var EASYRSA_REQ_EMAIL      \"me@6c0d.co\"" >> vars
echo "set_var EASYRSA_REQ_OU         \"Nothing\"" >> vars

echo ""
echo "1.2 -> Init tree"
cd /etc/openvpn
mkdir clientside
mkdir serverside
cp -Rf easy-rsa/easyrsa3 clientside/
cp -Rf easy-rsa/easyrsa3 serverside/

echo ""
echo "2 -> Genere CA"
cd /etc/openvpn/serverside/easyrsa3
./easyrsa init-pki
pwdca=`makepasswd --chars=20`
/usr/bin/expect<<EOF
set timeout -1
eval spawn "./easyrsa build-ca"
expect "Enter PEM pass phrase:" { send "$pwdca\r" }
expect "Verifying - Enter PEM pass phrase:" { send "$pwdca\r" }
expect "Common Name (eg: your user, host, or server name)" { send "6c0dVPN\r" }
expect "Your new CA certificate file for publishing is at"
EOF

echo ""
echo "3.1 -> Verify User"
if [ -z "$USEROVPN" ]; then
        echo "Username will be default user : s6c0d"
        nameuser="6c0d"
else
        nameuser=$USEROVPN
fi

echo ""
echo "3.2 -> Genere $nameuser.key" 
cd /etc/openvpn/clientside/easyrsa3
./easyrsa init-pki
/usr/bin/expect<<EOF
set timeout -1
eval spawn "./easyrsa gen-req $nameuser nopass"
expect "Common Name (eg: your user, host, or server name)" { send "$nameuser.key\r" }
expect "key: /etc/openvpn/clientside/easyrsa3/pki/private"
EOF

echo ""
echo "3.3 -> Genere $nameuser.crt"
cd /etc/openvpn/serverside/easyrsa3
./easyrsa import-req /etc/openvpn/clientside/easyrsa3/pki/reqs/$nameuser.req $nameuser

echo ""
echo "3.4 -> Sign req"
/usr/bin/expect<<EOF
set timeout -1
eval spawn "./easyrsa sign-req client $nameuser"
expect "Confirm request details:" {send "yes\r"}
expect "Enter pass phrase for /etc/openvpn/serverside/easyrsa3/pki/private/ca.key:" {send "$pwdca\r"}
expect "Certificate created at:"
EOF

echo ""
echo "4 -> Prepare conf VPN for client"
mkdir -p /etc/openvpn/clients/$nameuser
cd /etc/openvpn/clients/$nameuser
cat >client.ovpn<<EOL
client
dev tun
proto udp
remote $publicIP 1194
resolv-retry infinite
nobind
persist-key
persist-tun
ca ca.crt
auth-user-pass
comp-lzo
verb 3
ns-cert-type server
EOL

echo ""
echo "5 -> Create tar file for client"
cd /etc/openvpn/clients/$nameuser
cp /etc/openvpn/serverside/easyrsa3/pki/issued/$nameuser.crt .
cp /etc/openvpn/serverside/easyrsa3/ta.key .
cp /etc/openvpn/serverside/easyrsa3/pki/ca.crt .
cp /etc/openvpn/clientside/easyrsa3/pki/private/$nameuser.key .
cd /etc/openvpn/clients/
tar -cvf $nameuser.tar $nameuser

echo ""
echo "End Script"
